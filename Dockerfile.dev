# Dev container for libdft64 development
# Based on original libdft64 Dockerfile (Ubuntu 20.04 + Pin 3.20)
# Extended with LLVM 20 + clangd + lldb for development

FROM ubuntu:20.04

ARG DEBIAN_FRONTEND=noninteractive
ARG LLVM_VERSION=14
ARG GCC_VERSION=11

ENV PIN_TAR_NAME=pin-3.20-98437-gf02b61307-gcc-linux
ENV PIN_ROOT=/${PIN_TAR_NAME}
ENV LLVM_VERSION=${LLVM_VERSION}
ENV GCC_VERSION=${GCC_VERSION}

# --- Core system setup + original libdft64 dependencies ---
RUN apt-get update && \
    apt-get -y upgrade && \
    apt-get -y install \
    build-essential gcc-multilib g++-multilib wget \
    ca-certificates apt-transport-https gnupg curl \
    software-properties-common git make cmake \
    nano vim htop psmisc tmux gdb strace ltrace \
    python3 python3-dev python3-pip python-is-python3 \
    && apt-get clean

# --- Add apt.llvm.org repo for clang-14 ---
RUN wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add - && \
    echo "deb http://apt.llvm.org/focal/ llvm-toolchain-focal-${LLVM_VERSION} main" \
    > /etc/apt/sources.list.d/llvm.list

# --- Install clang-14 ---
RUN apt-get update && apt-get install -y --no-install-recommends \
    clang-${LLVM_VERSION} \
    && apt-get clean

# --- Compiler alternatives for LLVM 20 ---
RUN update-alternatives --install /usr/bin/clang clang /usr/bin/clang-${LLVM_VERSION} 100 && \
    update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-${LLVM_VERSION} 100

# --- Install Intel Pin (same version as original Dockerfile) ---
RUN wget http://software.intel.com/sites/landingpage/pintool/downloads/${PIN_TAR_NAME}.tar.gz && \
    tar xvf ${PIN_TAR_NAME}.tar.gz && \
    rm ${PIN_TAR_NAME}.tar.gz && \
    chmod -R a+rX ${PIN_ROOT} && \
    find ${PIN_ROOT} -type f -name "pin" -exec chmod a+x {} \; && \
    find ${PIN_ROOT}/intel64/bin -type f -exec chmod a+x {} \; 2>/dev/null || true

ENV PATH="${PIN_ROOT}:${PATH}"
ENV LLVM_CONFIG=llvm-config-${LLVM_VERSION}
ENV LLVM_DIR="/usr/lib/llvm-${LLVM_VERSION}/lib/cmake/llvm"

# --- Copy env.init script for Pin ptrace_scope setup ---
COPY ./env.init /opt/env.init
RUN chmod +x /opt/env.init

# --- Non-root user (VS Code convention) ---
ARG USERNAME=vscode
ARG USER_UID=1001
ARG USER_GID=${USER_UID}
RUN if ! getent group ${USER_GID} >/dev/null; then groupadd --gid ${USER_GID} ${USERNAME}; fi && \
    if ! id -u ${USERNAME} >/dev/null 2>&1; then \
    useradd -s /bin/bash --uid ${USER_UID} --gid ${USER_GID} -m ${USERNAME}; \
    fi && \
    apt-get update && apt-get install -y sudo && \
    echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/90-${USERNAME} && \
    chmod 0440 /etc/sudoers.d/90-${USERNAME}

# --- Create /data and /subjects directories ---
RUN mkdir -p /data /subjects && \
    chown -R ${USERNAME}:${USERNAME} /data /subjects

USER ${USERNAME}
WORKDIR /workspaces/libdft64

# --- Quality-of-life tweaks ---
RUN python3 -m pip install --no-cache-dir --upgrade pip && \
    echo "set encoding=utf-8" > ~/.vimrc && \
    echo "export PIN_ROOT=${PIN_ROOT}" >> ~/.bashrc && \
    echo "export PATH=\$PIN_ROOT:\$PATH" >> ~/.bashrc

CMD ["bash"]
